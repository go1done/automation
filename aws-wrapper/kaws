# Function to start bridge and wrap commands
krun() {
    # 1. Start bridge if not running
    if ! netstat -ano | grep 3128 | grep LISTENING > /dev/null; then
        # Use pythonw to run in background without a console window
        pythonw.exe //C/path/to/win_kbridge.py &
        sleep 2
    fi

    # 2. Proxy environment
    export HTTP_PROXY="http://127.0.0.1:3128"
    export HTTPS_PROXY="http://127.0.0.1:3128"
    
    # 3. SSL Fix: Point to the Windows Cert Store export or Corporate .pem
    # Terraform and AWS CLI need this if your proxy inspects SSL
    export AWS_CA_BUNDLE="/c/Users/$(whoami)/Documents/corp-ca.pem"
    export CURL_CA_BUNDLE="$AWS_CA_BUNDLE"

    "$@"
}

# Alias for convenience
alias kaws='krun aws'
alias ktf='krun terraform'
